<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataCerta - Confirmar Email</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .confirm-page {
            min-height: 100vh;
            background: linear-gradient(135deg, #0F172A 0%, #1E293B 50%, #0F172A 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-xl);
        }

        .confirm-card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: var(--spacing-2xl);
            text-align: center;
            max-width: 480px;
            width: 100%;
            box-shadow: var(--shadow-lg), 0 0 60px rgba(20, 184, 166, 0.1);
        }

        .status-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--spacing-lg);
        }

        .status-icon.loading {
            border: 4px solid var(--border-secondary);
            border-top-color: var(--accent-primary);
            animation: spin 0.8s linear infinite;
        }

        .status-icon.success {
            background: linear-gradient(135deg, var(--color-success) 0%, #059669 100%);
        }

        .status-icon.error {
            background: linear-gradient(135deg, var(--color-danger) 0%, #DC2626 100%);
        }

        .status-icon svg {
            width: 40px;
            height: 40px;
            color: white;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .confirm-title {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }

        .confirm-message {
            font-size: var(--font-size-md);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xl);
            line-height: 1.6;
        }

        .trial-info {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            text-align: left;
        }

        .trial-info h4 {
            font-size: var(--font-size-sm);
            color: var(--accent-primary);
            font-weight: 600;
            margin-bottom: var(--spacing-md);
        }

        .trial-info ul {
            list-style: none;
            padding: 0;
        }

        .trial-info li {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-xs) 0;
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        .trial-info li svg {
            width: 16px;
            height: 16px;
            color: var(--color-success);
        }

        .confirm-actions {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .confirm-actions .btn {
            width: 100%;
            padding: var(--spacing-md);
        }

        .credentials-box {
            background: #1E293B;
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            text-align: left;
        }

        .credentials-box h4 {
            font-size: var(--font-size-sm);
            color: #94A3B8;
            margin-bottom: var(--spacing-md);
        }

        .credential-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .credential-item:last-child {
            border-bottom: none;
        }

        .credential-item label {
            font-size: var(--font-size-sm);
            color: #64748B;
        }

        .credential-item span {
            font-family: monospace;
            font-size: var(--font-size-sm);
            color: #E2E8F0;
            background: rgba(255, 255, 255, 0.05);
            padding: 4px 8px;
            border-radius: 4px;
        }
    </style>
</head>

<body class="confirm-page">
    <div class="confirm-card">
        <!-- Loading State -->
        <div id="loadingState">
            <div class="status-icon loading"></div>
            <h1 class="confirm-title">Confirmando seu email...</h1>
            <p class="confirm-message">Aguarde enquanto ativamos seu período de teste.</p>
        </div>

        <!-- Success State -->
        <div id="successState" style="display: none;">
            <div class="status-icon success">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            </div>
            <h1 class="confirm-title">Email Confirmado!</h1>
            <p class="confirm-message">Seu período de teste de 7 dias foi ativado com sucesso.</p>

            <div class="trial-info">
                <h4>O que você pode fazer agora:</h4>
                <ul>
                    <li>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        Cadastrar até 500 produtos
                    </li>
                    <li>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        Adicionar até 2 usuários
                    </li>
                    <li>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        Gerenciar 1 loja
                    </li>
                    <li>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        Testar todas as funcionalidades
                    </li>
                </ul>
            </div>

            <div class="credentials-box">
                <h4>Suas credenciais de acesso:</h4>
                <div class="credential-item">
                    <label>Email:</label>
                    <span id="userEmail">-</span>
                </div>
                <div class="credential-item">
                    <label>Usuário:</label>
                    <span id="userUsername">-</span>
                </div>
                <p style="font-size: 12px; color: #94A3B8; margin-top: 12px;">
                    Você já definiu sua senha no cadastro. Use-a para entrar.
                </p>
            </div>

            <div class="confirm-actions">
                <a href="login.html" class="btn btn-primary">
                    Fazer Login
                </a>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" style="display: none;">
            <div class="status-icon error">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </div>
            <h1 class="confirm-title">Erro na Confirmação</h1>
            <p class="confirm-message" id="errorMessage">
                Não foi possível confirmar seu email. O link pode ter expirado ou já foi utilizado.
            </p>

            <div class="confirm-actions">
                <a href="trial.html" class="btn btn-primary">
                    Tentar Novamente
                </a>
                <a href="login.html" class="btn btn-outline">
                    Já tenho uma conta
                </a>
            </div>
        </div>

        <!-- Already Confirmed State -->
        <div id="alreadyConfirmedState" style="display: none;">
            <div class="status-icon success">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            </div>
            <h1 class="confirm-title">Email já confirmado</h1>
            <p class="confirm-message">
                Seu email já foi confirmado anteriormente. Faça login para acessar o sistema.
            </p>

            <div class="confirm-actions">
                <a href="login.html" class="btn btn-primary">
                    Fazer Login
                </a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase.js"></script>
    <script>
        const loadingState = document.getElementById('loadingState');
        const successState = document.getElementById('successState');
        const errorState = document.getElementById('errorState');
        const alreadyConfirmedState = document.getElementById('alreadyConfirmedState');
        const errorMessage = document.getElementById('errorMessage');
        const userEmail = document.getElementById('userEmail');
        const userUsername = document.getElementById('userUsername');

        function mostrarSucesso(email, username) {
            loadingState.style.display = 'none';
            successState.style.display = 'block';
            userEmail.textContent = email || '-';
            userUsername.textContent = username || '-';
        }

        function mostrarErro(mensagem) {
            loadingState.style.display = 'none';
            errorState.style.display = 'block';
            errorMessage.textContent = mensagem;
        }

        async function waitSupabase() {
            if (window.supabaseClient) return;
            await new Promise(resolve => {
                window.addEventListener('supabaseReady', resolve, { once: true });
            });
        }

        async function ensureSessionFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');

            // Supabase v2: Processar tokens do hash fragment usando setSession
            const hash = window.location.hash || '';
            if (hash.includes('access_token=')) {
                const hashParams = new URLSearchParams(hash.startsWith('#') ? hash.slice(1) : hash);
                const accessToken = hashParams.get('access_token');
                const refreshToken = hashParams.get('refresh_token');

                if (accessToken && refreshToken) {
                    const { error } = await window.supabaseClient.auth.setSession({
                        access_token: accessToken,
                        refresh_token: refreshToken
                    });
                    if (error) throw error;

                    // Limpar o hash da URL
                    window.history.replaceState({}, document.title, `${window.location.pathname}${window.location.search}`);
                    return;
                }
            }

            if (code && window.supabaseClient?.auth?.exchangeCodeForSession) {
                const { error } = await window.supabaseClient.auth.exchangeCodeForSession(code);
                if (error) throw error;
                params.delete('code');
                const clean = params.toString();
                const newUrl = `${window.location.pathname}${clean ? `?${clean}` : ''}`;
                window.history.replaceState({}, document.title, newUrl);
            }
        }

        async function criarEmpresa({ nomeEmpresa, cpfCnpj, telefone, email, trialEndsAt }) {
            const payload = {
                nome: nomeEmpresa,
                cnpj: cpfCnpj || null,
                email,
                telefone: telefone || null,
                status: 'trial',
                trial_ends_at: trialEndsAt
            };

            const { data, error } = await window.supabaseClient
                .from('empresas')
                .insert(payload)
                .select()
                .single();

            if (error) throw error;
            return data;
        }

        async function obterRoleAdminId(empresaId) {
            const { data } = await window.supabaseClient
                .from('roles')
                .select('id')
                .eq('empresa_id', empresaId)
                .eq('is_admin', true)
                .maybeSingle();
            return data?.id || null;
        }

        async function upsertUsuarioEmpresa({ userId, empresaId, roleId, email, nome, username }) {
            const payload = {
                id: userId,
                empresa_id: empresaId,
                role_id: roleId,
                email,
                nome,
                username,
                ativo: true
            };

            const { error } = await window.supabaseClient
                .from('usuarios')
                .upsert(payload, { onConflict: 'id' });

            if (error) throw error;
        }

        async function marcarTrialAtivo(email, empresaId, dataInicio, dataFim) {
            const { error } = await window.supabaseClient
                .from('trials_registro')
                .update({
                    status: 'ativo',
                    email_confirmado: true,
                    empresa_id: empresaId,
                    data_inicio: dataInicio,
                    data_fim: dataFim
                })
                .eq('email', email.toLowerCase())
                .in('status', ['pendente', 'ativo']);

            if (error) {
                console.warn('Não foi possível atualizar trials_registro:', error);
            }
        }

        async function ativarTrial() {
            try {
                await waitSupabase();
                await ensureSessionFromUrl();

                const { data: userRes, error: userErr } = await window.supabaseClient.auth.getUser();
                const user = userRes?.user;
                if (userErr || !user) {
                    mostrarErro('Sessão inválida. Abra novamente pelo link do email de confirmação.');
                    return;
                }

                // Verificar se já tem empresa
                const { data: usuarioExistente } = await window.supabaseClient
                    .from('usuarios')
                    .select('empresa_id, username')
                    .eq('id', user.id)
                    .maybeSingle();

                if (usuarioExistente?.empresa_id) {
                    loadingState.style.display = 'none';
                    alreadyConfirmedState.style.display = 'block';
                    return;
                }

                const meta = user.user_metadata || {};
                const trial = meta.trial || {};

                const nomeEmpresa = trial.nome_empresa || meta.nome_empresa || '';
                const cpfCnpj = trial.cpf_cnpj || meta.cpf_cnpj || null;
                const telefone = trial.telefone || meta.telefone || null;
                const nome = meta.nome || meta.nome_cliente || '';
                const username = meta.username || '';

                if (!nomeEmpresa || !user.email) {
                    mostrarErro('Dados do cadastro não encontrados. Refaça o cadastro do trial.');
                    return;
                }

                // Usar função RPC segura para ativar o trial
                const { data: resultado, error: rpcError } = await window.supabaseClient
                    .rpc('ativar_trial_empresa', {
                        p_nome_empresa: nomeEmpresa,
                        p_cpf_cnpj: cpfCnpj,
                        p_telefone: telefone,
                        p_email: user.email,
                        p_nome_usuario: nome,
                        p_username: username
                    });

                if (rpcError) {
                    console.error('Erro RPC ativar_trial_empresa:', rpcError);
                    throw new Error(rpcError.message || 'Erro ao ativar trial');
                }

                if (!resultado?.success) {
                    if (resultado?.already_exists) {
                        loadingState.style.display = 'none';
                        alreadyConfirmedState.style.display = 'block';
                        return;
                    }
                    throw new Error(resultado?.error || 'Erro ao ativar trial');
                }

                // Atualizar user metadata com empresa_id
                await window.supabaseClient.auth.updateUser({
                    data: { empresa_id: resultado.empresa_id, tipo: 'empresa' }
                });

                mostrarSucesso(user.email, username);
            } catch (error) {
                console.error('Erro ao ativar trial:', error);
                mostrarErro(error.message || 'Erro ao ativar sua conta. Tente novamente.');
            }
        }

        document.addEventListener('DOMContentLoaded', ativarTrial);
    </script>
</body>

</html>